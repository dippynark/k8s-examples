ISTIO_DIR=/opt/istio/istio-0.8.0
cd $ISTIO_DIR

# install istio
gcloud container clusters create istio --cluster-version=1.10
gcloud container clusters get-credentials istio
kubectl create serviceaccount tiller --namespace=kube-system
kubectl create clusterrolebinding tiller --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
helm init --service-account tiller
helm upgrade istio install/kubernetes/helm/istio --install --namespace istio-system # --set global.mtls.enabled=true

# install bookinfo
kubectl label namespace default istio-injection=enabled
kubectl apply -f samples/bookinfo/kube/bookinfo.yaml
istioctl create -f samples/bookinfo/routing/bookinfo-gateway.yaml
export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http")].port}')
export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].port}')
export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT

# check
curl -o /dev/null -s -w "%{http_code}\n" http://${GATEWAY_URL}/productpage


